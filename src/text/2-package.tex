\section{Analysis Workflow Overview}
\label{sec:analysis-workflow-overview}
\todo{Regis and Fabio F.}

\subsection{Data access and selection (DL3)}

The analysis of gamma-ray data with Gammapy starts at the Data Level 3 where the data consists
in lists of gamma-like events and their corresponding instrument response functions (IRFs).
The latter include effective area, point spread function (PSF), energy dispersion and
residual hadronic background. In addition there is associated meta data including information
on the observation such as pointing direction, observation time and observation conditions.

\subsection{Data reduction (DL3 to DL4)}

In the next stage of the analysis the user selects a coordinates system, region or
energy binning and events are binned into multidimensional data structures (maps)
with the selected geometry. The instrument response is projected onto the
same geometry as well. At this stage users can select additional background
estimation methods, such as ring background or reflected regions and
exclude parts of the data with high associated IRF systematics by defining
a "safe" data range. The counts data and the reduced IRFs are bundled into
datasets. Those datasets can be optionally grouped and stacked and are
typically written to disk to allow users to read them back at any time later
for modeling and fitting.

\subsection{Datasets (DL4)}

The datasets classes bundle reduced data in form of maps, reduced IRFs, models and
fit statistics. Different sub-classes support different analysis methods
and fit statistics (e.g. Poisson statistics with known background or
with OFF background measurements). The datasets are used to perform joint-likelihood
fitting allowing to combine different measurements, e.g. from different observations
but also from different instruments or event classes. They can also be used for binned
simulation as well as event sampling to simulate DL3 events data.

\subsection{Modeling and Fitting (DL4 to DL5)}

The next step is then typically to model and fit the datasets, either
individually, or in a joint likelihood analysis. For this purpose Gammapy
provides a uniform interface to multiple fitting backends. It also provides
a variety of :ref:`built in models <model-gallery>`. This includes spectral,
spatial and temporal model classes to describe the gamma-ray emission in the sky.
Independently or subsequently to the global modelling, the data can be
re-grouped to compute flux points, light curves and flux as well as significance
maps in energy bands.

\section{Gammapy package}
\label{sec:gammapy-package}

The \gammapy package is structured into multiple sub-packages which mostly
follow the stages in the data reduction workflow.

\subsection{Overview}
\label{ssec:overview}
\begin{figure*}[t]
	\centering
	\includegraphics[width=1.\textwidth]{figures/data_flow.pdf}
	\caption{
		Gammapy sub-package structure and data analysis workflow. }
	\label{fig:data_flow} \end{figure*}

Outline: * List typical analysis use cases * Can use from Python and Jupyter ->
show Figure with Jupyter notebook here. * Gammapy code structure * How Numpy
and Astropy is used

Figures: * Add a Figure showing dataflow in a typical application DL3 at the
top, spectrum, map, lightcurve, fit results at the bottom. Mention major
classes in between (DataStore, EventList, Map, MapMaker, MapFit, â€¦) * Probably
not: Figure showing sub-packages and how they relate (gammapy.data and
gammapy.irf at the base, then gammapy.maps, etc. * The code example Figure how
to make a counts map, to explain how the package works.

\todo{How to sort the sub-packages? After data flow or alphabetically? What
	about maps?}
\input{text/2-package-subsections/data}
\input{text/2-package-subsections/irf}
\input{text/2-package-subsections/maps}
\input{text/2-package-subsections/makers}
\input{text/2-package-subsections/datasets}
\input{text/2-package-subsections/modeling}
\input{text/2-package-subsections/stats}
\input{text/2-package-subsections/estimators}
\input{text/2-package-subsections/analysis}
\input{text/2-package-subsections/visualisation}
\input{text/2-package-subsections/astro}
\input{text/2-package-subsections/catalog}
\input{text/2-package-subsections/utils}
